events {
    worker_connections 1024;
}

http {
    # è®¾ç½®å­—ç¬¦ç¼–ç ä¸ºUTF-8ï¼Œè§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
    charset utf-8;
    
    # è®¾ç½®MIMEç±»å‹
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        listen 8090;
        server_name localhost;

        # åŸºæœ¬å¥åº·æ£€æŸ¥ï¼ˆä¸ä¾èµ–åç«¯ï¼‰
        location /health {
            access_log off;
            return 200 "nginx OK - åˆ†å¸ƒå¼èŠå¤©ç³»ç»Ÿè´Ÿè½½å‡è¡¡å™¨æ­£å¸¸è¿è¡Œ\nç½‘ç»œæ¨¡å¼: æ¡¥æ¥ç½‘ç»œ\n";
            add_header Content-Type "text/plain; charset=utf-8";
        }

        # ç³»ç»ŸçŠ¶æ€é¡µé¢
        location /status {
            access_log off;
            return 200 "Chat-Zinx åˆ†å¸ƒå¼èŠå¤©ç³»ç»Ÿ\nè´Ÿè½½å‡è¡¡å™¨: è¿è¡Œæ­£å¸¸\nNATS: nats-1:4222\nConsul: consul-1:8500\nChat TCP: ä½¿ç”¨ä¸»æœºç«¯å£ localhost:9000\n";
            add_header Content-Type "text/plain; charset=utf-8";
        }

        # å°è¯•ä»£ç†åˆ°chat-serverçš„HTTPæ¥å£ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        location /chat/ {
            proxy_pass http://localhost:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
            
            # å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
            error_page 502 503 504 = @fallback;
        }

        # Consulç®¡ç†ç•Œé¢ä»£ç†
        location /consul/ {
            proxy_pass http://consul-1:8500/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
        }

        # NATSç›‘æ§ä»£ç†
        location /nats/ {
            proxy_pass http://nats-1:8222/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
        }

        # åç«¯æœåŠ¡ä¸å¯ç”¨æ—¶çš„fallback
        location @fallback {
            return 503 "ChatæœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨\nè¯·ç›´æ¥è¿æ¥TCPç«¯å£: telnet localhost 9000\n";
            add_header Content-Type text/plain;
        }

        # é»˜è®¤é¦–é¡µ - æä¾›ç³»ç»Ÿè®¿é—®æŒ‡å—
        location / {
            return 200 "ğŸš€ æ¬¢è¿ä½¿ç”¨ Chat-Zinx åˆ†å¸ƒå¼èŠå¤©ç³»ç»Ÿ\n\nğŸŒ Webç®¡ç†ç•Œé¢:\n- ç³»ç»ŸçŠ¶æ€: http://localhost:8090/status\n- å¥åº·æ£€æŸ¥: http://localhost:8090/health\n- Consulç®¡ç†: http://localhost:8090/consul/\n- NATSç›‘æ§: http://localhost:8090/nats/\n\nğŸ’¬ èŠå¤©æœåŠ¡:\n- TCPèŠå¤©: telnet localhost 9000\n- ç›´æ¥è®¿é—®: http://localhost:8080\n\nğŸ“Š ç›‘æ§æœåŠ¡:\n- Grafana: http://localhost:3000\n- Prometheus: http://localhost:9090\n\nç³»ç»Ÿè¿è¡ŒçŠ¶æ€: æ­£å¸¸ âœ…\n";
            add_header Content-Type "text/plain; charset=utf-8";
        }
    }

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;
} 